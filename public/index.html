<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shortlink - Dashboard</title>
    <style>
      :root {
        --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        --card-bg: #ffffff;
        --primary: #3498db;
        --primary-hover: #2980b9;
        --success: #27ae60;
        --error: #e74c3c;
        --text-main: #2c3e50;
        --text-muted: #7f8c8d;
        --border: #e0e0e0;
        --radius-lg: 16px;
        --radius-md: 8px;
        --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.1);
        --focus-ring: 0 0 0 3px rgba(52, 152, 219, 0.2);
      }

      * { margin: 0; padding: 0; box-sizing: border-box; }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-gradient);
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        padding: 40px 20px;
        color: var(--text-main);
      }

      .container {
        width: 100%;
        max-width: 900px;
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        padding: 40px;
      }

      h1 { font-size: 2rem; margin-bottom: 10px; }
      .subtitle { color: var(--text-muted); margin-bottom: 30px; }

      /* Tabs */
      .tabs { display: flex; gap: 16px; margin-bottom: 30px; border-bottom: 2px solid var(--border); }
      .tab {
        padding: 10px 20px;
        background: none;
        border: none;
        font-weight: 600;
        color: var(--text-muted);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
      }
      .tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); }

      /* Stats */
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 30px;
      }
      .stat-card {
        padding: 20px;
        background: #f8f9fa;
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
      }
      .stat-card h3 { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px; }
      .stat-card .value { font-size: 1.5rem; font-weight: bold; color: var(--primary); }

      /* Actions */
      .actions {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        margin-bottom: 30px;
      }

      /* Forms */
      .form-group { margin-bottom: 20px; text-align: left; }
      label { display: block; margin-bottom: 8px; font-weight: 500; }
      
      input, select {
        width: 100%;
        padding: 14px;
        font-size: 16px;
        border-radius: var(--radius-md);
        border: 2px solid var(--border);
        transition: border-color 0.2s;
      }
      input:focus, select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: var(--focus-ring);
      }

      button {
        padding: 14px 24px;
        font-size: 16px;
        border-radius: var(--radius-md);
        background: var(--primary);
        color: white;
        border: none;
        cursor: pointer;
        transition: background 0.2s;
      }
      button:hover { background: var(--primary-hover); }
      button.btn-danger { background: transparent; color: var(--error); padding: 8px 12px; font-size: 14px; }
      button.btn-danger:hover { background: #fee; }
      button.btn-copy { background: transparent; color: var(--primary); padding: 8px 12px; font-size: 14px; }
      button.btn-copy:hover { background: #f0f8ff; }

      /* Lists */
      .link-item, .domain-item {
        padding: 14px;
        border-radius: var(--radius-md);
        background: white;
        border: 1px solid var(--border);
        margin-bottom: 10px;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        align-items: center;
      }
      .link-info .short { color: var(--primary); font-weight: 600; text-decoration: none; }
      .link-meta, .domain-meta { font-size: 13px; color: var(--text-muted); margin-top: 4px; }

      /* Utilities */
      .hidden { display: none; }
      
      /* Toast */
      .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: #2c3e50;
        color: white;
        padding: 12px 18px;
        border-radius: 8px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.2s ease, transform 0.2s ease;
        pointer-events: none;
        z-index: 1000;
      }
      .toast.show { opacity: 1; transform: translateY(0); }
      
      /* Results */
      #resultContainer {
        margin-top: 20px;
        padding: 15px;
        background: #f0fff4;
        border: 1px solid #b2f5ea;
        border-radius: var(--radius-md);
        color: #276749;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="tabs">
        <button class="tab active" data-view="dashboard">Dashboard</button>
        <button class="tab" data-view="create">Create Link</button>
        <button class="tab" data-view="domain">Domain</button>
      </div>

      <div id="dashboardView" class="view-section">
        <h1>Dashboard</h1>
        <p class="subtitle">Manage and monitor your shortened links</p>

        <section class="stats">
          <div class="stat-card">
            <h3>Total Links</h3>
            <div class="value" id="totalLinks">—</div>
          </div>
          <div class="stat-card">
            <h3>Total Clicks</h3>
            <div class="value" id="totalClicks">—</div>
          </div>
        </section>

        <section class="actions">
          <input type="url" id="quickUrlInput" placeholder="Paste a long URL to shorten quickly..." />
          <button id="quickCreateBtn">Create</button>
        </section>

        <div id="linksList" class="links-container">
            <p style="text-align: center; color: #999;">Loading links...</p>
        </div>
      </div>

      <div id="domainView" class="view-section hidden">
        <h1>Domain Settings</h1>
        <p class="subtitle">Connect custom domains for your links</p>
        
        <form id="domainForm" class="form-group">
          <div class="actions">
            <input id="newDomainInput" placeholder="example.com" required />
            <button type="submit">Add</button>
          </div>
        </form>
        <div id="domainsList" class="domains-list"></div>
      </div>

      <div id="createView" class="view-section hidden">
        <h1>Create Short Link</h1>
        <p class="subtitle">Customize your short URL</p>

        <form id="linkForm">
          <div class="form-group">
            <label for="longUrlInput">Long URL</label>
            <input type="url" id="longUrlInput" placeholder="https://..." required />
          </div>

          <div class="form-group">
            <label for="domainSelect">Domain</label>
            <select id="domainSelect">
              <option value="">Default (current host)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="customSlugInput">Custom Slug (Optional)</label>
            <input type="text" id="customSlugInput" placeholder="my-custom-name" />
          </div>

          <button type="submit">Create Link</button>
        </form>

        <div id="resultContainer" class="hidden">
            <p><strong>Short Link Created:</strong></p>
            <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">
                <a id="resultShortUrl" href="#" target="_blank" class="link-info"></a>
                <button id="resultCopyBtn" class="btn-copy">Copy</button>
            </div>
        </div>
      </div>
    </div>

    <div id="toast" class="toast">Action Successful</div>

    <script>
      // --- Elements ---
      const views = {
        dashboard: document.getElementById('dashboardView'),
        create: document.getElementById('createView'),
        domain: document.getElementById('domainView')
      };
      
      const els = {
        linksList: document.getElementById('linksList'),
        domainsList: document.getElementById('domainsList'),
        domainSelect: document.getElementById('domainSelect'),
        
        // Stats
        statLinks: document.getElementById('totalLinks'),
        statClicks: document.getElementById('totalClicks'),
        
        // Inputs
        quickUrl: document.getElementById('quickUrlInput'),
        longUrl: document.getElementById('longUrlInput'),
        customSlug: document.getElementById('customSlugInput'),
        newDomain: document.getElementById('newDomainInput'),
        
        // Results
        resultContainer: document.getElementById('resultContainer'),
        resultShort: document.getElementById('resultShortUrl'),
        resultCopy: document.getElementById('resultCopyBtn'),
        
        toast: document.getElementById('toast')
      };

      // --- Helper Functions ---
      
      function showToast(msg) {
        els.toast.textContent = msg;
        els.toast.classList.add('show');
        setTimeout(() => els.toast.classList.remove('show'), 3000);
      }

      async function apiCall(endpoint, options = {}) {
        try {
          const res = await fetch(endpoint, {
            headers: { 'Content-Type': 'application/json' },
            ...options,
          });
          
          if (!res.ok) {
            throw new Error(`Error: ${res.statusText}`);
          }
          
          // Handle empty responses (like DELETE)
          if (res.status === 204) return null;
          
          return await res.json();
        } catch (err) {
          console.error(err);
          showToast(err.message || "API Request Failed");
          return null;
        }
      }

      function switchView(viewName) {
        // Update Tabs
        document.querySelectorAll('.tab').forEach(t => {
            t.classList.toggle('active', t.dataset.view === viewName);
        });
        
        // Update Sections
        Object.keys(views).forEach(k => {
            views[k].classList.toggle('hidden', k !== viewName);
        });

        // Trigger Data Loads
        if (viewName === 'dashboard') loadDashboardData();
        if (viewName === 'domain') loadDomainsData();
        if (viewName === 'create') {
            loadDomainsData().then(() => {
                // Ensure dropdown is populated when entering create view
            }); 
            els.resultContainer.classList.add('hidden');
        }
      }

      // --- Data Loading ---

      async function loadDashboardData() {
        const links = await apiCall('/api/links');
        if (!links) return;

        // Calculate Stats
        const totalLinks = links.length;
        const totalClicks = links.reduce((sum, item) => sum + (item.clicks || 0), 0);
        
        els.statLinks.textContent = totalLinks;
        els.statClicks.textContent = totalClicks;

        if(links.length === 0) {
            els.linksList.innerHTML = `<p style="text-align:center; padding: 20px; color: #888;">No links created yet.</p>`;
            return;
        }

        els.linksList.innerHTML = links.map(l => {
          // Construct URL
          const fullUrl = `https://${l.domains.domain}/s/${l.links.slug}`;
          // NOTE: We wrap the string values in quotes inside the onclick handlers!
          return `
            <div class="link-item">
              <div class="link-info">
                <a href="${fullUrl}" target="_blank" class="short">${l.domains.domain}/s/${l.links.slug}</a>
                <div class="link-meta">${l.clicks || 0} clicks &bull; ${l.links.url || 'Original URL hidden'}</div>
              </div>
              <div class="link-actions">
                <button class="btn-copy" onclick="copyToClipboard('${fullUrl}')">Copy</button>
                <button class="btn-danger" onclick="deleteLink('${l.links.slug}', '${l.domains.domain}')">Remove</button>
              </div>
            </div>`;
        }).join('');
      }

      async function loadDomainsData() {
        const domains = await apiCall('/api/domains');
        if (!domains) return;

        // Populate List
        els.domainsList.innerHTML = domains.map(d => `
          <div class="domain-item">
            <div>
              <div class="domain-name">${d.domain}</div>
              <div class="domain-meta">Added ${new Date(d.addedAt || Date.now()).toLocaleDateString()}</div>
            </div>
            <div class="domain-actions">
                <button class="btn-danger" onclick="deleteDomain('${d.domain}')">Remove</button>
            </div>
          </div>
        `).join('');

        // Populate Dropdown (Save current selection if exists)
        const currentSelection = els.domainSelect.value;
        els.domainSelect.innerHTML = '<option value="">Default (Current Host)</option>';
        domains.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.domain;
            opt.textContent = d.domain;
            els.domainSelect.appendChild(opt);
        });
        if(currentSelection) els.domainSelect.value = currentSelection;
      }

      // --- Actions ---

      async function deleteDomain(domainStr) {
        if(!confirm(`Delete domain ${domainStr}?`)) return;
        const res = await apiCall(`/api/domains/${encodeURIComponent(domainStr)}`, { method: 'DELETE' });
        loadDomainsData(); // Refresh list
        showToast("Domain removed");
      }

      async function deleteLink(slugStr, domainStr) {
        if(!confirm("Are you sure you want to delete this link?")) return;
        const res = await apiCall(`/api/links/${encodeURIComponent(slugStr)}?domain=${encodeURIComponent(domainStr)}`, { method: 'DELETE' });
        loadDashboardData(); // Refresh list
        showToast("Link deleted");
      }

      async function handleCreate(e) {
        e.preventDefault();
        
        const urlVal = els.longUrl.value;
        const domainVal = els.domainSelect.value || location.host;
        const slugVal = els.customSlug.value;

        const payload = { url: urlVal, domain: domainVal };
        if (slugVal) payload.slug = slugVal;

        const res = await apiCall('/api/links/create', {
          method: 'POST',
          body: JSON.stringify(payload),
        });

        if (res) {
          const finalSlug = res.slug || slugVal;
          const fullShortUrl = `https://${domainVal}/s/${finalSlug}`;
          
          els.resultShort.textContent = fullShortUrl;
          els.resultShort.href = fullShortUrl;
          
          // Setup copy button on result
          els.resultCopy.onclick = () => copyToClipboard(fullShortUrl);
          
          els.resultContainer.classList.remove('hidden');
          showToast("Link Created!");
          
          // Reset form basics, but keep domain selected
          els.longUrl.value = '';
          els.customSlug.value = '';
        }
      }

      // --- Event Listeners ---

      // Tab Navigation
      document.querySelectorAll('.tab').forEach(btn => {
        btn.onclick = () => switchView(btn.dataset.view);
      });

      // Quick Create Button (Dashboard)
      document.getElementById('quickCreateBtn').onclick = () => {
        const val = els.quickUrl.value;
        if(val) {
            els.longUrl.value = val;
            switchView('create');
            els.quickUrl.value = ''; // clear input
        } else {
            els.quickUrl.focus();
        }
      };

      // Create Form
      document.getElementById('linkForm').onsubmit = handleCreate;

      // Domain Form
      document.getElementById('domainForm').onsubmit = async (e) => {
        e.preventDefault();
        const d = els.newDomain.value;
        if(d) {
            await apiCall('/api/domains', { // Assuming POST endpoint for creating domain
                method: 'POST', 
                body: JSON.stringify({ domain: d }) 
            });
            els.newDomain.value = '';
            loadDomainsData();
            showToast("Domain added");
        }
      };

      function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => showToast("Copied to clipboard!"));
        } else {
            showToast("Unable to copy (HTTPS required)");
        }
      }

      // --- Init ---
      switchView('dashboard');
    </script>
  </body>
</html>
